<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAAD-DOH Premium Exam 1 | Gulf Medical Examz</title>
    
    <script src="https://www.paypal.com/sdk/js?client-id=test&currency=USD"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .exam-card {
            background: white;
            width: 90%;
            max-width: 800px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        .hidden { display: none !important; }

        /* Payment UI */
        #payment-screen { text-align: center; }
        .price-tag { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 20px 0; }

        /* Exam UI */
        .exam-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 30px; }
        #timer { font-weight: 700; color: var(--danger); background: #fef2f2; padding: 8px 15px; border-radius: 8px; }
        .question-text { font-size: 1.3rem; font-weight: 600; margin-bottom: 25px; display: flex; justify-content: space-between; gap: 20px; }
        .flag-icon { cursor: pointer; font-size: 1.6rem; color: #cbd5e1; }
        .flag-icon.flagged { color: #ef4444 !important; }
        .options-container { display: grid; gap: 12px; }
        .option { padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .option:hover { border-color: var(--primary); background: #f0f7ff; }
        .option.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .controls { margin-top: 35px; display: flex; gap: 12px; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: var(--secondary); color: white; }
        .btn-submit { background: var(--success); color: white; margin-left: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    </style>
</head>
<body>

    <div id="payment-screen" class="exam-card hidden">
        <h1 style="font-size: 4rem; margin: 0;">üîí</h1>
        <h2>Unlock Premium Exam 1</h2>
        <p>This high-yield mock exam requires a one-time payment.</p>
        <div class="price-tag">$5.00 USD</div>
        <div id="paypal-button-container"></div>
        <button onclick="window.location.href='haad-doh.html'" style="margin-top: 20px; background: none; color: var(--secondary);">Cancel</button>
    </div>

    <div id="start-screen" class="exam-card hidden" style="text-align: center;">
        <h1>HAAD-DOH Mock Exam 1</h1>
        <p>50 Questions | 40 Minutes</p>
        <button class="btn-next" onclick="startExam()">Start Exam Now</button>
    </div>

    <div id="exam-screen" class="exam-card hidden">
        <div class="exam-header">
            <span id="q-counter">Question 1/50</span>
            <div id="timer">40:00</div>
        </div>
        <div id="question-area">
            <div class="question-text">
                <span id="question-content">Loading...</span>
                <span id="flag-btn" class="flag-icon" onclick="toggleFlag()">‚öë</span>
            </div>
            <div id="options-list" class="options-container"></div>
        </div>
        <div class="controls">
            <button class="btn-prev" onclick="prevQuestion()">Previous</button>
            <button class="btn-next" onclick="nextQuestion()">Next</button>
            <button id="submit-btn" class="btn-submit hidden" onclick="showResults()">Show Results</button>
        </div>
    </div>

    <div id="results-screen" class="exam-card hidden">
        <div style="text-align: center;">
            <h2>Exam Completed</h2>
            <h1 id="score-display">0/50</h1>
            <p id="percentage-display"></p>
        </div>
        <div id="results-sheet"></div>
        <button class="btn-next" style="width: 100%; margin-top: 20px;" onclick="location.reload()">Restart Exam</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4kGcT5L6p1B1aD2WAeo0OCXin1If8B_o",
            authDomain: "gulfmedicalexamz.firebaseapp.com",
            projectId: "gulfmedicalexamz",
            storageBucket: "gulfmedicalexamz.firebasestorage.app",
            messagingSenderId: "23161933734",
            appId: "1:23161933734:web:06b63e4853387efc174967"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- EXAM DATA ---
        const questions = [
            {
                id: 1,
                text: "Which of the following antibacterial drug remains longer duration of action?",
                options: ["Benzathine penicillin", "Ethambutol", "Azithromycin", "Kanamycin"],
                correct: 0
            },
            {
                id: 2,
                text: "When dosing trimethoprim/sulfamethoxazole combination, the dosage recommendation is based on which component?",
                options: ["Either one", "Trimethoprim", "Sulfamethoxazole", "Dose is fixed"],
                correct: 1
            }
            // Add your other 48 questions here
        ];

        let currentIdx = 0;
        let timeLeft = 40 * 60;
        let userAnswers = new Array(questions.length).fill(null);
        let flaggedQuestions = [];
        let timerInterval;

        // --- AUTH & PAYMENT LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            // Check if user paid for "exam1"
            const docRef = doc(db, "users", user.uid, "payments", "exam1");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                document.getElementById('start-screen').classList.remove('hidden');
            } else {
                document.getElementById('payment-screen').classList.remove('hidden');
                renderPayPal(user.uid);
            }
        });

        function renderPayPal(uid) {
            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: '5.00' },
                            description: "HAAD-DOH Premium Exam 1"
                        }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(async (details) => {
                        await setDoc(doc(db, "users", uid, "payments", "exam1"), {
                            paid: true,
                            email: details.payer.email_address,
                            date: new Date().toISOString()
                        });
                        location.reload(); // Refresh to unlock the exam
                    });
                }
            }).render('#paypal-button-container');
        }

        // --- EXAM ENGINE FUNCTIONS ---
        window.startExam = function() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('exam-screen').classList.remove('hidden');
            renderQuestion();
            startTimer();
        };

        function startTimer() {
            timerInterval = setInterval(() => {
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); showResults(); }
                timeLeft--;
            }, 1000);
        }

        window.renderQuestion = function() {
            const q = questions[currentIdx];
            document.getElementById('q-counter').innerText = `Question ${currentIdx + 1} / ${questions.length}`;
            document.getElementById('question-content').innerText = q.text;
            
            const flagBtn = document.getElementById('flag-btn');
            flagBtn.classList.toggle('flagged', flaggedQuestions.includes(currentIdx));

            const container = document.getElementById('options-list');
            container.innerHTML = '';
            q.options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = `option ${userAnswers[currentIdx] === i ? 'selected' : ''}`;
                div.innerText = opt;
                div.onclick = () => selectOption(i);
                container.appendChild(div);
            });

            document.getElementById('submit-btn').classList.toggle('hidden', currentIdx !== (questions.length - 1));
        };

        window.selectOption = (i) => { userAnswers[currentIdx] = i; renderQuestion(); };
        window.nextQuestion = () => { if (currentIdx < questions.length - 1) { currentIdx++; renderQuestion(); } };
        window.prevQuestion = () => { if (currentIdx > 0) { currentIdx--; renderQuestion(); } };
        
        window.toggleFlag = function() {
            const pos = flaggedQuestions.indexOf(currentIdx);
            if (pos > -1) flaggedQuestions.splice(pos, 1);
            else flaggedQuestions.push(currentIdx);
            renderQuestion();
        };

        window.showResults = function() {
            clearInterval(timerInterval);
            document.getElementById('exam-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            let score = 0;
            let tableHTML = `<table><tr><th>Question</th><th>Result</th></tr>`;
            userAnswers.forEach((ans, i) => {
                const isCorrect = ans === questions[i].correct;
                if (isCorrect) score++;
                tableHTML += `<tr><td>#${i+1}</td><td>${isCorrect ? '‚úÖ' : '‚ùå'}</td></tr>`;
            });
            tableHTML += `</table>`;
            
            document.getElementById('score-display').innerText = `${score} / ${questions.length}`;
            document.getElementById('percentage-display').innerText = `Score: ${(score/questions.length*100).toFixed(1)}%`;
            document.getElementById('results-sheet').innerHTML = tableHTML;
        };
    </script>
</body>
</html>
